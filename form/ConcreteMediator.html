<!--
*
Implements the Mediator interface
*
-->
<link rel="import" href="../GlobalDependencies.html">
<link rel="import" href="MModel.html">
<link rel="import" href="VList.html">
<link rel="import" href="VForm.html">
<link rel="import" href="VNavigation.html">
<link rel="import" href="VToolbar.html">

<dom-module id='concrete-mediator'>
    <template>
        <style is='custom-style'>
            .flex-stretch-align {
                @apply(--layout-horizontal);
                height: 100%;
            }

            .flex-stretch-vertical {
                @apply(--layout-vertical);
                height: 100%;
            }

            .dataform,
            .datalist {
                @apply(--layout-flex-1);
                flex: 1;
            }

            #form {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                align-content: flex-start;
            }

            #paperDrawerPanel [main] {
                text-align: center;
                background-color: var(--google-grey-100);
            }
        </style>
        <m-model id='formData' items='{{items}}'></m-model>
        <paper-toast id="notifyTost" text="Default text"></paper-toast>
        <paper-drawer-panel id="appDrawer" force-narrow>
            <paper-header-panel drawer>
                <v-navigation items='{{items.navigationBar}}'></v-navigation>
            </paper-header-panel>
            <paper-header-panel main>
                <v-toolbar active-view='{{activeView}}' items='{{items.toolbar}}'></v-toolbar>
                <div class='container flex-stretch-align' id='formContainer' hidden$="{{checkActiveView('form')}}">
                    <v-list class='datalist flex-stretch-vertical' id='list' items='[[items.table]]'></v-list>
                    <v-form class='dataform container flex-stretch-vertical' id='form'></v-form>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
    </template>
    </template>
    <script>
        Polymer({
            is: 'concrete-mediator',

            properties: {
                selectedItem: {
                    type: Number
                },
                items: {
                    type: Array,
                    notify: true
                },
                activeView: {
                    type: String,
                    notify: true,
                    value: 'form'
                }
            },

            listeners: {
                'change-selection': '_loadDataToForm',
                'handle-save': 'handleSave',
                'handle-remove': 'handleRemove',
                'toggle-drawer': 'toggleDrawer',
                'active-view-changed': 'activeViewChanged'
            },

            observers: [
                'itemsAddedOrRemoved(items.splices)'
            ],

            handleRemove: function() {
                this.splice('items.table', this.selectedItem, 1);
                this.$.list.deselectListItem();
                this.$.notifyTost.text = 'Item removed';
                this.$.notifyTost.open();
            },

            handleSave: function() {
                var changes = this.$.form.formChanges;
                for (change in changes) {
                    this.set('items.#' + this.selectedItem + change.replace('formData', ''), changes[change].value);
                }
                this.$.list.updateFormList();
                this.$.form.formChanges = {};
            },

            toggleDrawer: function() {
                this.$.appDrawer.togglePanel();
            },

            itemsAddedOrRemoved: function(data) {
                //some collection change evnt. verify on deletion or addition
            },

            _loadDataToForm: function(event) {
                var item = event.detail.item;
                this.selectedItem = this.items.table.indexOf(item);
                if (item && item.length > 0) {
                    this.$.form.setData(item);
                }
            },

            checkActiveView: function(requestedView) {
                return this.activeView === requestedView;
            },

            activeViewChanged: function() {
                var currentActiveView = this.activeView;
                switch (currentActiveView) {
                    case 'form':
                        this.$.formContainer.hidden = false;
                        break;
                    default:
                        this.$.formContainer.hidden = false;
                }
            }
        });
    </script>
</dom-module>
